@using SportsClothes.UI.WEBAPP.Models.ViewModels
@using SportsClothes.INTERFACES
@using SportsClothes.UI.WEBAPP.Models.Dto
@using SportsClothes.CORE
@using SportsClothes.UI.WEBAPP.Models
@using SportsClothes.UI.WEBAPP.Models.FilterObjects
@inject NavigationManager Navigation
@inject HttpClient HttpClient
@inject IJSRuntime JsRuntime
@page "/"

<PageTitle>Products</PageTitle>

<h1>Products</h1>

@if (_producers.Count != 0)
{
    <form @onsubmit="AddProduct">
        <div class="row mb-3">
            <div class="col-xs-12 col-md-4">
                <div class="form-group">
                    <label for="name">*Name:</label>
                    <input id="name" class="form-control" @bind="_newProduct.Name" required minlength="3" maxlength="25" />
                </div>
            </div>

            <div class="col-xs-12 col-md-2">
                <div class="form-group">
                    <label for="size">*Size:</label>
                    <input id="size" class="form-control" @bind="_newProduct.Size" required minlength="1" maxlength="2" />
                </div>
            </div>

            <div class="col-xs-12 col-md-4">
                <div class="form-group">
                    <label for="color">*Color:</label>
                    <input id="color" class="form-control" @bind="_newProduct.Color" required minlength="3" maxlength="25" />
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-xs-12 col-md-2">
                <div class="form-group">
                    <label for="price">*Price (zł):</label>
                    <input id="price" class="form-control" @bind="_newProduct.Price" type="number" min="0" max="99999" step="0.01" required/>
                </div>
            </div>

            <div class="col-xs-6 col-md-2">
                <div class="form-group">
                    <label for="type">*Type:</label>
                    <select id="type" class="form-control" @bind="_newProduct.Type" required>
                        <option value="@ProductType.Shoes">@ProductType.Shoes.ToString()</option>
                        <option value="@ProductType.Jacket">@ProductType.Jacket.ToString()</option>
                        <option value="@ProductType.Pants">@ProductType.Pants.ToString()</option>
                        <option value="@ProductType.TShirt">@ProductType.TShirt.ToString()</option>
                        <option value="@ProductType.Hoodie">@ProductType.Hoodie.ToString()</option>
                    </select>
                </div>
            </div>

            <div class="col-xs-6 col-md-4">
                <div class="form-group">
                    <label for="producer">*Producer:</label>
                    <select id="producer" class="form-control" @bind="_newProduct.ProducerId" required>
                        @foreach (var producer in _producers)
                        {
                            <option value="@producer.Id">@producer.Name</option>
                        }
                    </select>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-success mb-4">Add Product</button>

    </form>
}

<div class="row">
    <div class="col-lg-4 mb-3">
        <div class="form-group">
            <label for="search">Search:</label>
            <input id="search" class="form-control" @bind="_filter.SearchTerm" maxlength="25" />
        </div>
    </div>

    <div class="col-lg-2 mb-3">
        <div class="form-group">
            <label for="size">Size:</label>
            <input id="size" class="form-control" @bind="_filter.Size" maxlength="2" />
        </div>
    </div>
    
    <div class="col-lg-4 mb-3">
        <label for="priceRange">Price range:</label>
        <div id="priceRange" class="form-group row">
            <div class="col-6">
                <input class="form-control" @bind="_filter.PriceLowerBound" type="number" min="0" max="99999" step="0.01"/>
            </div>
            <div class="col-6">
                <input class="form-control" @bind="_filter.PriceUpperBound" type="number" min="0" max="99999" step="0.01" />
            </div>
        </div>
    </div>
 </div>
<div class="row">
    <div class="col-lg-2 mb-3">
        <div class="form-group">
            <label for="filterType">Type:</label>
            <select id="filterType" class="form-control" @bind="_filter.Type">
                <option value="">All types</option>
                <option value="@ProductType.Shoes">@ProductType.Shoes.ToString()</option>
                <option value="@ProductType.Jacket">@ProductType.Jacket.ToString()</option>
                <option value="@ProductType.Pants">@ProductType.Pants.ToString()</option>
                <option value="@ProductType.TShirt">@ProductType.TShirt.ToString()</option>
                <option value="@ProductType.Hoodie">@ProductType.Hoodie.ToString()</option>
            </select>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="form-group">
            <label for="filterProducer">Producer:</label>
            <select id="filterProducer" class="form-control" @bind="_filter.ProducerId">
                <option value="0">All Producers</option>
                @foreach (var producer in _producers)
                {
                    <option value="@producer.Id">@producer.Name</option>
                }
            </select>
        </div>
    </div> 
</div>
<div>
    <button class="btn btn-primary mb-4" @onclick="ApplyFilters">
        <i class="oi oi-magnifying-glass"></i> Search
    </button>
    <button class="btn btn-secondary mb-4" @onclick="ClearFilters">
        Clear Filters
    </button>
</div>

@if (_products.Count != 0)
{
    <table class="table mb-5" style="table-layout: auto">
        <thead>
        <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Size</th>
            <th>Color</th>
            <th>Price (zł)</th>
            <th>Producer</th>
            <th></th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        @foreach (var product in _products)
        {
            <tr>
                    <td>@product.Name</td>
                    <td>@product.Type</td>
                    <td>@product.Size</td>
                    <td>@product.Color</td>
                    <td>@product.Price</td>
                    <td>@product.Producer</td>
                <td>
                    <button class="btn btn-outline-primary" @onclick="() => GoToEditProduct(product.Id)">
                        <i class="oi oi-pencil" aria-hidden="true"></i> Edit
                    </button>
                </td>
                <td>
                    <button class="btn btn-outline-danger" @onclick="() => DeleteProduct(product.Id)">
                        <i class="oi oi-circle-x" aria-hidden="true"></i> Delete
                    </button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}
else
{
    <table class="table mb-5" style="table-layout: auto">
        <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Size</th>
                <th>Color</th>
                <th>Price (zł)</th>
                <th>Producer</th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="9" class="text-center">
                    <span><strong>Sorry! We did not find any data for you.</strong></span>
                </td>
            </tr>
        </tbody>
    </table>
}

@code {
    private IList<ProductViewModel> _products = new List<ProductViewModel>();
    private IList<ProducerData> _producers = new List<ProducerData>();
    private IProductDto _newProduct = new ProductDto();

    private IProductFilter _filter = new ProductFilter();

    protected override async Task OnInitializedAsync()
    {
        await LoadProducerInfo();
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        try
        {
            var response = await HttpClient.GetFromJsonAsync<IList<ProductViewModel>>("api/products");

            if (response != null)
            {
                _products = response.OrderByDescending(v => v.Id).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private async Task LoadProducerInfo()
    {
        try
        {
            var response = await HttpClient.GetFromJsonAsync<IList<ProducerData>>("api/products/producers");

            if (response != null)
            {
                _producers = response.OrderBy(p => p.Name).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private async Task AddProduct()
    {
        var response = await HttpClient.PostAsJsonAsync("api/products/create", _newProduct);

        if (!response.IsSuccessStatusCode)
            await Popup(await response.Content.ReadAsStringAsync());
        else
            _newProduct = new ProductDto();

        await LoadProducts();
    }

    private async Task Popup(string message)
    {
        await JsRuntime.InvokeVoidAsync("alert", message);
    }

    private async Task DeleteProduct(int id)
    {
        var confirmed = await ConfirmPopup();

        if (!confirmed)
            return;

        var result = await HttpClient.DeleteAsync($"api/products/delete/{id}");

        if (!result.IsSuccessStatusCode)
            await Popup("Failed to delete product. Please try again later.");

        await LoadProducts();
    }

    private async Task<bool> ConfirmPopup()
    {
        return await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete product?");
    }

    private void GoToEditProduct(int id)
    {
        Navigation.NavigateTo($"/products/{id}");
    }

    private async Task ApplyFilters()
    {
        var response = await HttpClient.PostAsJsonAsync("api/products/filter", _filter);

        if (!response.IsSuccessStatusCode)
        {
            await Popup(await response.Content.ReadAsStringAsync());
            return;
        }

        var result = await response.Content.ReadFromJsonAsync<IList<ProductViewModel>>();
        _products = result.OrderByDescending(v => v.Id).ToList();

    }

    private async Task ClearFilters()
    {
        _filter = new ProductFilter();
        await LoadProducts();
    }
}
